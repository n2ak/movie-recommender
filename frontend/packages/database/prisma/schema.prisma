generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model UserModel {
  id       Int     @id @unique
  username String
  email    String  @unique
  password String
  active   Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt

  movieRatings    UserMovieRating[]
  movieReviews    MovieReview[]
  reviewReactions ReviewReaction[]

  @@map("user")
}

model MovieModel {
  tmdbId        Int      @id @unique
  title         String
  genres        String[]
  avg_rating    Float
  href          String
  total_ratings Int

  production_companies String[]
  original_language    String
  overview             String
  tagline              String
  credits              String[]
  keywords             String[]
  duration             Float
  overview_encoded     Unsupported("vector(384)")?

  release_date DateTime @db.Timestamptz(3)

  createdAt  DateTime          @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime          @default(now()) @updatedAt
  userRating UserMovieRating[]
  reviews    MovieReview[]

  @@map("movie")
}

model UserMovieRating {
  id     Int   @id @default(autoincrement())
  rating Float

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt

  tmdbId      Int
  userModelId Int

  movie MovieModel @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)
  user  UserModel  @relation(fields: [userModelId], references: [id], onDelete: Cascade)

  @@unique([tmdbId, userModelId])
  @@map("movie_rating")
}

model MovieReview {
  id          Int      @id @default(autoincrement())
  tmdbId      Int
  userModelId Int
  title       String
  text        String
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @default(now()) @updatedAt
  nlikes      Int
  ndislikes   Int

  reactions ReviewReaction[]
  movie     MovieModel       @relation(fields: [tmdbId], references: [tmdbId], onDelete: Cascade)
  user      UserModel        @relation(fields: [userModelId], references: [id], onDelete: Cascade)

  @@unique([tmdbId, userModelId])
}

model ReviewReaction {
  id            Int                @id @default(autoincrement())
  movieReviewId Int
  userModelId   Int
  createdAt     DateTime           @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime           @default(now()) @updatedAt
  type          ReviewReactionType

  movie_review MovieReview @relation(fields: [movieReviewId], references: [id], onDelete: Cascade)
  user         UserModel   @relation(fields: [userModelId], references: [id], onDelete: Cascade)

  @@unique([movieReviewId, userModelId])
}

enum ReviewReactionType {
  LIKE
  DISLIKE
}
